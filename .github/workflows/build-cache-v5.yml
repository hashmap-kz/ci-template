name: ci

on:
  push:

jobs:
  integ:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pg_major: [17, 18]

    env:
      PG_MAJOR: ${{ matrix.pg_major }}
      COMPOSE_FILE: test/integration/environ/docker-compose.yml

    steps:
      - uses: actions/checkout@v6

#      - name: Set up Go
#        uses: actions/setup-go@v6
#        with:
#          go-version-file: go.mod
#
#      - name: Build binary
#        run: |
#          set -euo pipefail
#          make build
#          mv bin test/integration/environ

      # (see section 2 â€“ buildx cache)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images
        run: |
          set -euo pipefail
          docker compose -f "${COMPOSE_FILE}" build pg-primary pg-standby sshd minio createbuckets

      - name: Run tests
        run: |
          set -euo pipefail
          docker compose -f "${COMPOSE_FILE}" up -d
          docker ps
