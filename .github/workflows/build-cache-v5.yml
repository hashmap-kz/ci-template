name: Docker Image CI

on:
  push:

jobs:
  build_images:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # PG images (multi-version)
          - name: pg-primary
            pg_major: 17
          - name: pg-primary
            pg_major: 18
          - name: pg-standby
            pg_major: 17
          - name: pg-standby
            pg_major: 18

          # Other images (no PG_MAJOR needed)
          - name: minio
          - name: minio_mc
          - name: sshd

    env:
      # Will be "17"/"18" for pg images, and empty for others
      PG_MAJOR: ${{ matrix.pg_major }}

      # Handy suffix for tags / filenames / cache keys, e.g. "-17" or ""
      TAG_SUFFIX: ${{ matrix.pg_major && format('-{0}', matrix.pg_major) || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers for ${{ matrix.name }}${{ env.TAG_SUFFIX }}
        uses: actions/cache@v4
        with:
          path: /tmp/.${{ matrix.name }}${{ env.TAG_SUFFIX }}
          key: ${{ matrix.name }}${{ env.TAG_SUFFIX }}
          restore-keys: |
            ${{ matrix.name }}${{ env.TAG_SUFFIX }}-

      - name: Build '${{ matrix.name }}' image
        uses: docker/build-push-action@v6
        with:
          context: test/integration/environ
          file: test/integration/environ/dockerfiles/${{ matrix.name }}/Dockerfile
          #platforms: linux/amd64,linux/arm64
          #push: ${{ github.ref_type == 'tag' }}
          # Example tag pattern: pgrwl/pg-primary-17, pgrwl/minio
          tags: |
            pgrwl/${{ matrix.name }}${{ env.TAG_SUFFIX }}
          build-args: |
            PG_MAJOR=${{ env.PG_MAJOR }}
          cache-from: type=local,src=/tmp/.${{ matrix.name }}${{ env.TAG_SUFFIX }}
          cache-to: type=local,dest=/tmp/.new-${{ matrix.name }}${{ env.TAG_SUFFIX }},mode=max
          # Export for tests (only needed for pg images, but harmless for others)
          outputs: type=docker,dest=${{ runner.temp }}/${{ matrix.name }}${{ env.TAG_SUFFIX }}.tar

      # Only upload artifacts for pg-* images (used by tests)
      - name: Upload pg image artifact
        if: startsWith(matrix.name, 'pg-')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}${{ env.TAG_SUFFIX }}
          path: ${{ runner.temp }}/${{ matrix.name }}${{ env.TAG_SUFFIX }}.tar

      - name: Move cache for ${{ matrix.name }}${{ env.TAG_SUFFIX }}
        run: |
          rm -rf /tmp/.${{ matrix.name }}${{ env.TAG_SUFFIX }}
          mv /tmp/.new-${{ matrix.name }}${{ env.TAG_SUFFIX }} /tmp/.${{ matrix.name }}${{ env.TAG_SUFFIX }}

  test:
    name: Run integration tests (pg${{ matrix.pg_major }})
    runs-on: ubuntu-latest
    needs: [build_images]

    strategy:
      fail-fast: false
      matrix:
        pg_major: [17, 18]

    env:
      PG_MAJOR: ${{ matrix.pg_major }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Download all image artifacts (pg-*, minio, minio_mc, sshd)
      - name: Download all images
        uses: actions/download-artifact@v4
        with:
          pattern: "*.tar"
          path: ${{ runner.temp }}
          merge-multiple: true

      - name: Load all images
        env:
          TEMP_DIR: ${{ runner.temp }}
        run: |
          set -euo pipefail
          for img in "${TEMP_DIR}"/*.tar; do
            echo "Loading image: $img"
            docker load --input "$img"
          done

          docker image ls -a

      # now all images (pg-*, minio, minio_mc, sshd) are available
      # - name: Run integration tests
      #   run: ./scripts/run-tests.sh
